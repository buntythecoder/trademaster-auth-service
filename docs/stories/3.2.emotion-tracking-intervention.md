# Story 3.2: Emotion Tracking Dashboard & Intervention System

## Status
Draft

## Story
**As a** TradeMaster user seeking to improve my trading discipline,
**I want** an emotion tracking dashboard that correlates my emotional state with trading performance and provides real-time intervention when I'm likely to make emotional decisions,
**so that** I can build better trading habits, avoid costly emotional mistakes, and achieve more consistent trading results.

## Acceptance Criteria

1. Dashboard displays emotion timeline correlated with P&L performance
2. Users can log emotional state before trades for correlation analysis
3. Real-time alerts warn users when AI detects emotional trading patterns
4. Intervention system suggests cooling-off periods during high-emotion periods
5. Personalized coaching messages adapt to individual behavioral patterns
6. Visual correlation charts show relationship between emotions and trading outcomes
7. Behavioral score tracks improvement in trading discipline over time
8. Intervention effectiveness is measured and reported to users
9. Dashboard provides insights on best and worst trading emotional states
10. System learns from user feedback to improve intervention timing and messaging

## Tasks / Subtasks

- [ ] **Task 1: Emotion Tracking Data Model & Service** (AC: 1, 2, 7)
  - [ ] Design emotion tracking data model with mood states and intensity levels
  - [ ] Implement EmotionTrackingService for mood logging and correlation analysis
  - [ ] Create emotion-to-performance correlation calculation algorithms
  - [ ] Set up emotional state persistence in InfluxDB for time-series analysis
  - [ ] Implement behavioral score calculation and trending
  - [ ] Create emotion data validation and sanitization
  - [ ] Add emotion tracking analytics and reporting capabilities

- [ ] **Task 2: Real-time Intervention Engine** (AC: 3, 4, 10)
  - [ ] Implement real-time emotion detection from trading behavior patterns
  - [ ] Create intervention trigger logic based on behavioral AI predictions
  - [ ] Build cooling-off period recommendation system with dynamic timing
  - [ ] Set up intervention notification delivery (push, email, in-app)
  - [ ] Implement user feedback collection for intervention effectiveness
  - [ ] Create intervention learning system to improve timing and messaging
  - [ ] Add intervention override and user control mechanisms

- [ ] **Task 3: Personalized Coaching System** (AC: 5, 8, 10)
  - [ ] Design coaching message framework with behavioral pattern templates
  - [ ] Implement personalized coaching recommendation engine
  - [ ] Create coaching message adaptation based on user response patterns
  - [ ] Set up coaching effectiveness measurement and A/B testing
  - [ ] Build coaching content management system with message library
  - [ ] Implement coaching delivery optimization (timing, frequency, format)
  - [ ] Add coaching progress tracking and milestone recognition

- [ ] **Task 4: Emotion Dashboard Frontend Components** (AC: 1, 6, 9)
  - [ ] Create emotion timeline visualization component with P&L overlay
  - [ ] Implement emotion-performance correlation charts and heatmaps
  - [ ] Build mood logging interface with quick emotional state selection
  - [ ] Create best/worst emotional state analysis dashboard
  - [ ] Implement behavioral score visualization with trend analysis
  - [ ] Add emotion-based trading insights and recommendations
  - [ ] Create responsive design for mobile emotion tracking

- [ ] **Task 5: Dashboard Analytics & Insights** (AC: 6, 7, 9)
  - [ ] Implement statistical correlation analysis between emotions and performance
  - [ ] Create emotion-based trading pattern identification
  - [ ] Build predictive analytics for optimal emotional states for trading
  - [ ] Generate personalized insights and recommendations
  - [ ] Create comparative analysis against anonymized user benchmarks
  - [ ] Implement emotion-based risk assessment and position sizing recommendations
  - [ ] Add trend analysis for emotional maturity and trading discipline

- [ ] **Task 6: API Endpoints & Real-time Updates** (AC: 1, 3, 7)
  - [ ] Create REST API endpoints for emotion logging and retrieval
  - [ ] Implement real-time emotion tracking updates via WebSocket
  - [ ] Add behavioral score and intervention API endpoints
  - [ ] Create coaching message delivery and feedback APIs
  - [ ] Implement emotion analytics and insights API endpoints
  - [ ] Set up intervention trigger and notification APIs
  - [ ] Add emotion dashboard data aggregation endpoints

- [ ] **Task 7: Integration with Behavioral AI Service** (AC: 3, 4, 5)
  - [ ] Integrate with Story 3.1 behavioral AI for emotion prediction
  - [ ] Set up real-time behavioral pattern detection for intervention triggers
  - [ ] Implement emotion prediction confidence scoring
  - [ ] Create feedback loop from intervention effectiveness to AI model
  - [ ] Add behavioral pattern correlation with emotional states
  - [ ] Integrate coaching recommendations with AI-detected patterns
  - [ ] Set up emotion tracking data as input for behavioral AI training

- [ ] **Task 8: Unit and Integration Testing** (AC: All)
  - [ ] Write unit tests for emotion tracking and correlation algorithms
  - [ ] Create integration tests for real-time intervention system
  - [ ] Test coaching personalization and effectiveness measurement
  - [ ] Verify dashboard visualization accuracy and performance
  - [ ] Test API integration with behavioral AI service
  - [ ] Create load testing for real-time emotion tracking updates
  - [ ] Test mobile responsiveness and cross-platform compatibility
  - [ ] Validate intervention learning system and feedback processing

## Dev Notes

### Previous Story Insights
**From Story 3.1:** Behavioral AI service provides pattern detection and emotional state predictions that will trigger interventions and coaching.
**From Epic 1:** User authentication provides secure access to personal emotional data.
**From Epic 2:** Trading data provides performance metrics for emotion-performance correlation.

### Emotion Tracking Data Model
**Emotional State Categories:**
- **Fear:** Market anxiety, loss aversion, panic selling
- **Greed:** Overconfidence, FOMO (fear of missing out), excessive risk-taking
- **Neutral:** Calm, analytical, disciplined trading state
- **Frustration:** Revenge trading, impatience, anger at losses
- **Euphoria:** Overoptimism after wins, reduced risk awareness

**Emotion Intensity Scale:**
- 1-2: Mild emotional influence
- 3-4: Moderate emotional state affecting decisions
- 5-6: Strong emotional influence on trading behavior
- 7-8: High emotional intensity requiring intervention
- 9-10: Extreme emotional state, trading suspension recommended

**Emotion Data Model:**
```python
from enum import Enum
from datetime import datetime
from pydantic import BaseModel

class EmotionalState(Enum):
    FEAR = "fear"
    GREED = "greed"
    NEUTRAL = "neutral"
    FRUSTRATION = "frustration"
    EUPHORIA = "euphoria"

class EmotionEntry(BaseModel):
    user_id: int
    emotional_state: EmotionalState
    intensity: int  # 1-10 scale
    timestamp: datetime
    pre_trade: bool  # True if logged before trade
    trade_id: Optional[int]  # Associated trade if applicable
    notes: Optional[str]  # User notes about emotional state
    context: Dict[str, Any]  # Market context, news events, etc.
```

### Dashboard Data Schema
**InfluxDB Emotion Tracking Schema:**
```sql
-- Emotion tracking measurement
emotion,user_id=123,state=greed,intensity=7 pre_trade=true,trade_correlation=0.85 1609459200000000000

-- Behavioral score measurement
behavioral_score,user_id=123 discipline=0.78,consistency=0.82,risk_management=0.75 1609459200000000000

-- Intervention effectiveness measurement
intervention,user_id=123,type=cooling_off effectiveness=0.91,user_rating=4 1609459200000000000
```

**PostgreSQL Emotion Tables (to be created):**
```sql
CREATE TABLE emotion_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    emotional_state VARCHAR(20) NOT NULL,
    intensity INTEGER CHECK (intensity >= 1 AND intensity <= 10),
    pre_trade BOOLEAN DEFAULT false,
    trade_id INTEGER REFERENCES trades(id),
    notes TEXT,
    market_context JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE behavioral_scores (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    score_date DATE NOT NULL,
    discipline_score DECIMAL(3,2),
    consistency_score DECIMAL(3,2),
    risk_management_score DECIMAL(3,2),
    overall_score DECIMAL(3,2),
    improvement_trend DECIMAL(3,2),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, score_date)
);

CREATE TABLE interventions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    intervention_type VARCHAR(50) NOT NULL,
    trigger_pattern VARCHAR(100),
    message_content TEXT,
    delivered_at TIMESTAMP NOT NULL,
    user_response VARCHAR(20), -- accepted, ignored, dismissed
    effectiveness_rating INTEGER CHECK (effectiveness_rating >= 1 AND effectiveness_rating <= 5),
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Real-time Intervention Engine
**Intervention Trigger Logic:**
```python
class InterventionEngine:
    def __init__(self, behavioral_ai_service):
        self.ai_service = behavioral_ai_service
        self.intervention_rules = self.load_intervention_rules()
    
    async def evaluate_intervention_need(self, user_id, trading_context):
        # Get current emotional state prediction from AI
        emotional_prediction = await self.ai_service.predict_emotion(user_id, trading_context)
        
        # Check against intervention thresholds
        if emotional_prediction.risk_score > 0.8:
            return await self.generate_intervention(user_id, emotional_prediction)
        
        return None
    
    async def generate_intervention(self, user_id, prediction):
        # Select appropriate intervention based on pattern and user history
        # Generate personalized message
        # Schedule delivery with optimal timing
        # Track intervention for effectiveness measurement
        return intervention
```

**Intervention Types:**
- **Cooling-off Suggestions:** Recommend breaks during high emotional intensity
- **Risk Reduction Alerts:** Suggest position size reduction during overconfidence
- **Pattern Warnings:** Alert about detected behavioral biases
- **Breathing Exercises:** Mindfulness techniques for emotional regulation
- **Historical Reminders:** Show past outcomes of similar emotional states

### Personalized Coaching System
**Coaching Message Framework:**
```python
class CoachingEngine:
    def __init__(self):
        self.message_templates = self.load_coaching_templates()
        self.user_preferences = {}
        
    def generate_coaching_message(self, user_id, behavioral_pattern, context):
        # Get user's coaching history and effectiveness
        user_profile = self.get_user_coaching_profile(user_id)
        
        # Select appropriate coaching approach
        coaching_style = self.determine_coaching_style(user_profile, behavioral_pattern)
        
        # Generate personalized message
        message = self.personalize_message(coaching_style, context, user_profile)
        
        return message
    
    def measure_coaching_effectiveness(self, user_id, coaching_session):
        # Track behavioral changes after coaching
        # Measure user engagement and response
        # Calculate effectiveness score
        # Update coaching personalization
        return effectiveness_score
```

**Coaching Personalization Factors:**
- Trading experience level and sophistication
- Previous response to different coaching styles
- Cultural and communication preferences
- Emotional intelligence and self-awareness level
- Historical coaching effectiveness scores

### Dashboard Visualization Components
**Emotion-Performance Correlation Charts:**
```typescript
interface EmotionPerformanceData {
  timestamp: Date;
  emotionalState: EmotionalState;
  intensity: number;
  pnl: number;
  tradesCount: number;
  avgTradeSize: number;
}

class EmotionDashboard {
  renderCorrelationChart(data: EmotionPerformanceData[]) {
    // Create scatter plot with emotion intensity vs performance
    // Add trend lines and correlation coefficients
    // Highlight optimal emotional zones for trading
    // Show interactive tooltips with trade details
  }
  
  renderEmotionTimeline(data: EmotionPerformanceData[]) {
    // Display emotion states over time with P&L overlay
    // Show intervention points and effectiveness
    // Highlight behavioral pattern occurrences
    // Add zoom and filter capabilities
  }
}
```

### Behavioral Score Calculation
**Scoring Algorithm:**
```python
class BehavioralScoreCalculator:
    def calculate_discipline_score(self, user_trades, interventions, timeframe):
        # Measure adherence to trading plan and risk management
        # Factor in intervention acceptance rate
        # Consider consistency of trading behavior
        # Weight recent behavior more heavily
        return discipline_score
    
    def calculate_consistency_score(self, user_trades, emotions, timeframe):
        # Measure emotional stability across different market conditions
        # Analyze trade sizing consistency
        # Factor in decision-making under pressure
        # Consider improvement trends
        return consistency_score
    
    def calculate_overall_score(self, discipline, consistency, risk_management):
        # Weighted combination of individual scores
        # Apply user-specific weighting based on goals
        # Include peer benchmarking where appropriate
        # Generate improvement recommendations
        return overall_score
```

### API Specifications
**Emotion Tracking API Endpoints (to be implemented):**
- `POST /api/v1/emotions/log` - Log emotional state entry
- `GET /api/v1/emotions/timeline` - Get emotion timeline with P&L correlation
- `GET /api/v1/emotions/analysis` - Get emotion-performance analysis
- `GET /api/v1/behavioral-score` - Get current behavioral score and trends
- `POST /api/v1/interventions/feedback` - Provide intervention effectiveness feedback
- `GET /api/v1/coaching/messages` - Get personalized coaching recommendations
- `WebSocket /ws/interventions` - Real-time intervention delivery
- `GET /api/v1/emotions/insights` - Get personalized emotional trading insights

### File Locations
**Project Structure:** Full-stack application architecture:
- `src/emotion-tracking/` - Emotion tracking backend service
- `src/emotion-tracking/services/` - Emotion and intervention business logic
- `src/emotion-tracking/models/` - Emotion and behavioral score data models
- `src/emotion-tracking/api/` - REST API endpoints and WebSocket handlers
- `src/emotion-tracking/coaching/` - Coaching engine and message management
- `src/emotion-tracking/analytics/` - Emotion analytics and correlation analysis
- `frontend/src/components/emotion/` - React components for emotion dashboard
- `frontend/src/services/emotion/` - Frontend emotion tracking services
- `tests/` - Unit and integration tests

### Performance Requirements
**Dashboard Performance Targets:**
- Emotion logging API: <200ms response time
- Dashboard load time: <3 seconds for 6-month emotion history
- Real-time intervention delivery: <500ms from trigger to notification
- Correlation analysis: <1 second for complex statistical calculations
- WebSocket message delivery: <100ms latency for real-time updates

### Integration Requirements
**Service Integration:**
- Story 3.1 Behavioral AI: Real-time emotion prediction and pattern detection
- Epic 2 Trading API: Trade data for emotion-performance correlation
- Epic 1 Authentication: Secure access to personal emotional data
- Notification service: Multi-channel intervention delivery
- Mobile app integration: Emotion logging and intervention display

## Testing

### Testing Standards
**Testing Requirements:** The Developer should implement comprehensive testing following these guidelines:

**Test File Locations:**
- Unit tests: `tests/unit/emotion_tracking/`
- Integration tests: `tests/integration/emotion_tracking/`
- Frontend tests: `frontend/tests/emotion/`
- E2E tests: `tests/e2e/emotion_dashboard/`

**Testing Frameworks and Patterns:**
- pytest for Python backend testing
- Jest and React Testing Library for frontend component testing
- Selenium for end-to-end dashboard testing
- WebSocket testing utilities for real-time intervention testing
- Statistical testing libraries for correlation analysis validation

**Specific Testing Requirements for This Story:**
- Test emotion logging accuracy and data validation
- Verify emotion-performance correlation calculations with statistical significance
- Test real-time intervention trigger logic and delivery
- Validate coaching personalization and effectiveness measurement
- Test dashboard visualization accuracy and interactive features
- Verify API integration with behavioral AI service
- Test mobile responsiveness and cross-platform compatibility
- Load testing for concurrent emotion tracking and intervention delivery
- Test user privacy and data security for emotional information
- Validate behavioral score calculation accuracy and trending

**Emotional Intelligence Testing:**
- Test intervention timing optimization with user feedback
- Verify coaching message effectiveness across different user types
- Test emotional state prediction accuracy against self-reported emotions
- Validate intervention learning system improvement over time

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References  
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story implementation review*