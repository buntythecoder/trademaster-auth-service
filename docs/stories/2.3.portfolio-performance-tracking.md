# Story 2.3: Portfolio Management & Performance Tracking

## Status
Draft

## Story
**As a** TradeMaster user with active trading positions,
**I want** comprehensive portfolio tracking with performance analytics, risk metrics, and benchmarking capabilities,
**so that** I can monitor my trading performance, understand my risk exposure, and make informed decisions about portfolio optimization.

## Acceptance Criteria

1. Users can view complete portfolio summary with current positions and values
2. Real-time P&L tracking shows unrealized and realized gains/losses  
3. Portfolio performance metrics include returns, volatility, and Sharpe ratio
4. Position sizing and risk exposure analytics are calculated automatically
5. Portfolio rebalancing suggestions are generated based on user preferences
6. Performance benchmarking compares user results to market indices
7. Historical portfolio performance charts are available with multiple timeframes
8. Risk metrics include maximum drawdown, beta, and correlation analysis
9. Tax reporting features calculate capital gains and losses for Indian regulations
10. Portfolio alerts notify users of significant position changes or risk breaches

## Tasks / Subtasks

- [ ] **Task 1: Portfolio Data Model & Core Service** (AC: 1, 2)
  - [ ] Design comprehensive portfolio data model with positions, transactions, and metadata
  - [ ] Implement PortfolioService with real-time position aggregation and value calculation
  - [ ] Create portfolio snapshot functionality for historical tracking
  - [ ] Add multi-currency support for different asset classes (equity, commodity, forex)
  - [ ] Implement position-level details with cost basis, current value, and P&L
  - [ ] Create portfolio hierarchy support for sub-portfolios and asset groupings
  - [ ] Add real-time portfolio value updates using market data from Story 2.1

- [ ] **Task 2: P&L Calculation Engine** (AC: 2, 9)
  - [ ] Implement real-time unrealized P&L calculation using live market prices
  - [ ] Create realized P&L tracking for closed positions using FIFO/LIFO methods
  - [ ] Add intraday P&L calculation for day trading activities
  - [ ] Implement currency conversion for multi-currency positions
  - [ ] Create P&L attribution analysis (sector, stock, time period)
  - [ ] Add dividend and corporate action handling for accurate returns
  - [ ] Implement Indian tax calculation for capital gains (short-term, long-term)

- [ ] **Task 3: Performance Analytics Engine** (AC: 3, 6, 7)
  - [ ] Calculate portfolio returns (absolute, annualized, time-weighted)
  - [ ] Implement volatility calculations (standard deviation, downside deviation)
  - [ ] Create Sharpe ratio, Sortino ratio, and other risk-adjusted metrics
  - [ ] Add benchmark comparison against NSE indices (Nifty 50, Sensex, sector indices)
  - [ ] Implement performance attribution analysis (security, sector, style)
  - [ ] Create rolling performance metrics for different time windows
  - [ ] Add alpha and beta calculations relative to market benchmarks

- [ ] **Task 4: Risk Analytics & Monitoring** (AC: 4, 8, 10)
  - [ ] Implement position sizing analysis and concentration risk metrics
  - [ ] Calculate portfolio beta, correlation matrix, and diversification ratios
  - [ ] Add Value at Risk (VaR) and Expected Shortfall calculations
  - [ ] Create maximum drawdown tracking and recovery analysis
  - [ ] Implement sector and stock exposure limits monitoring
  - [ ] Add leverage and margin utilization tracking
  - [ ] Create risk alert system for threshold breaches

- [ ] **Task 5: Portfolio Optimization & Rebalancing** (AC: 5)
  - [ ] Implement mean reversion and momentum-based rebalancing strategies
  - [ ] Create target allocation management with drift monitoring
  - [ ] Add rebalancing cost analysis including brokerage and taxes
  - [ ] Implement portfolio optimization using Modern Portfolio Theory
  - [ ] Create smart rebalancing suggestions based on user risk tolerance
  - [ ] Add calendar-based and threshold-based rebalancing triggers
  - [ ] Implement tax-efficient rebalancing strategies for Indian markets

- [ ] **Task 6: Historical Data & Charting** (AC: 7)
  - [ ] Create portfolio performance history storage and retrieval
  - [ ] Implement charting data preparation for multiple timeframes
  - [ ] Add portfolio composition tracking over time
  - [ ] Create performance comparison charts against benchmarks
  - [ ] Implement drawdown and recovery visualization
  - [ ] Add correlation and risk metric historical trending
  - [ ] Create export functionality for external analysis tools

- [ ] **Task 7: API Endpoints & Real-time Updates** (AC: 1, 2, 10)
  - [ ] Create REST API endpoints for portfolio data retrieval
  - [ ] Implement WebSocket updates for real-time portfolio value changes
  - [ ] Add GraphQL endpoints for flexible portfolio data queries
  - [ ] Create portfolio summary APIs with customizable views
  - [ ] Implement performance analytics API with caching
  - [ ] Add portfolio alert subscription and notification system
  - [ ] Create bulk portfolio data export APIs for institutional users

- [ ] **Task 8: Unit and Integration Testing** (AC: All)
  - [ ] Write unit tests for P&L calculation accuracy across different scenarios
  - [ ] Test performance metric calculations against known benchmarks
  - [ ] Create integration tests for real-time portfolio updates
  - [ ] Test risk analytics calculations for accuracy and performance
  - [ ] Test portfolio rebalancing logic and optimization algorithms
  - [ ] Verify tax calculation compliance with Indian capital gains rules
  - [ ] Test WebSocket portfolio updates under high-frequency trading scenarios
  - [ ] Create load testing for portfolio analytics with large position datasets

## Dev Notes

### Previous Story Insights
**From Story 1.1:** User authentication provides secure access to portfolio data with subscription tier controls.
**From Story 2.1:** Market data service provides real-time prices for portfolio valuation and P&L calculations.
**From Story 2.2:** Trading API provides trade execution data for portfolio position updates and realized P&L tracking.

### Data Models
**Source: [docs/architecture/data-architecture.md#postgresql-primary-transactional-database]**

**Existing Portfolio Schema:**
```sql
CREATE TABLE portfolios (
    user_id INTEGER REFERENCES users(id),
    symbol VARCHAR(20) NOT NULL,
    quantity INTEGER NOT NULL,
    avg_price DECIMAL(10,2) NOT NULL,
    unrealized_pnl DECIMAL(15,2),
    updated_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (user_id, symbol)
);
```

**Extended Portfolio Schema (to be created):**
```sql
CREATE TABLE portfolio_snapshots (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    snapshot_date DATE NOT NULL,
    total_value DECIMAL(15,2) NOT NULL,
    realized_pnl DECIMAL(15,2) NOT NULL,
    unrealized_pnl DECIMAL(15,2) NOT NULL,
    performance_metrics JSONB,
    risk_metrics JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE portfolio_performance (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    period_type VARCHAR(20) NOT NULL, -- DAILY, WEEKLY, MONTHLY, YEARLY
    period_date DATE NOT NULL,
    total_return DECIMAL(10,4),
    benchmark_return DECIMAL(10,4),
    volatility DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    beta DECIMAL(10,4),
    alpha DECIMAL(10,4),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, period_type, period_date)
);

CREATE TABLE portfolio_alerts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    alert_type VARCHAR(50) NOT NULL,
    threshold_value DECIMAL(15,2),
    current_value DECIMAL(15,2),
    triggered_at TIMESTAMP,
    acknowledged_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Performance Analytics Requirements
**Source: [docs/architecture/data-architecture.md#influxdb-time-series-market-data]**

**Portfolio Time-Series Data:**
```sql
-- Portfolio value measurement
portfolio_value,user_id=123,currency=INR total_value=250000.50,unrealized_pnl=15000.25 1609459200000000000

-- Performance metrics measurement
portfolio_performance,user_id=123,period=daily return=0.025,volatility=0.15,sharpe=1.67 1609459200000000000

-- Risk metrics measurement
portfolio_risk,user_id=123 var_95=5000.0,max_drawdown=0.08,beta=1.15 1609459200000000000
```

**Analytics Calculations Required:**
- Time-weighted returns for accurate performance measurement
- Risk-adjusted metrics (Sharpe, Sortino, Calmar ratios)
- Benchmark-relative metrics (alpha, beta, tracking error)
- Risk metrics (VaR, Expected Shortfall, maximum drawdown)
- Portfolio attribution (security, sector, style contributions)

### API Specifications
**Source: [docs/architecture/core-services-architecture.md#3-trading-api-service]**

**Existing Trading Endpoints:**
- `/api/v1/portfolio` - Portfolio management and P&L
- `/api/v1/positions` - Real-time position tracking

**Extended Portfolio API Endpoints (to be implemented):**
- `GET /api/v1/portfolio/summary` - Complete portfolio overview
- `GET /api/v1/portfolio/performance` - Performance metrics and analytics
- `GET /api/v1/portfolio/risk` - Risk metrics and exposure analysis
- `GET /api/v1/portfolio/history` - Historical performance data
- `GET /api/v1/portfolio/benchmarks` - Benchmark comparison data
- `POST /api/v1/portfolio/rebalance` - Get rebalancing recommendations
- `GET /api/v1/portfolio/tax-report` - Tax reporting for capital gains
- `WebSocket /ws/portfolio` - Real-time portfolio value updates

### Risk Management Integration
**Source: [docs/architecture/security-architecture.md#financial-security]**

**Portfolio Risk Monitoring:**
```java
@Service
public class PortfolioRiskService {
    
    public RiskMetrics calculateRiskMetrics(Portfolio portfolio) {
        // Calculate Value at Risk using historical simulation
        // Compute maximum drawdown and recovery periods
        // Analyze concentration risk and sector exposure
        // Calculate correlation with market indices
        // Monitor leverage and margin utilization
        return riskMetrics;
    }
    
    public List<Alert> checkRiskThresholds(Portfolio portfolio, User user) {
        // Check position concentration limits
        // Validate sector exposure limits  
        // Monitor maximum loss thresholds
        // Check leverage ratio limits
        return riskAlerts;
    }
}
```

### Indian Tax Compliance
**Tax Calculation Requirements:**
- Short-term capital gains (STCG): Holdings < 1 year taxed at 15%
- Long-term capital gains (LTCG): Holdings > 1 year taxed at 10% above ₹1 lakh
- Dividend income taxation based on user's income tax slab
- Securities Transaction Tax (STT) calculation and reporting
- TDS calculation for dividend income above threshold

**Tax Reporting Implementation:**
```java
@Service
public class TaxCalculationService {
    
    public TaxReport calculateCapitalGains(List<Trade> trades, int financialYear) {
        // Calculate STCG and LTCG based on holding periods
        // Apply indexation benefits for LTCG where applicable
        // Calculate STT and other transaction costs
        // Generate Form 16A equivalent data for filing
        return taxReport;
    }
}
```

### Performance Requirements
**Source: [docs/architecture/performance-scalability.md#performance-targets]**

**Portfolio Performance Targets:**
- Portfolio summary API: <200ms response time
- Real-time P&L updates: <100ms propagation via WebSocket
- Performance analytics: <500ms for complex calculations
- Risk metrics calculation: <300ms for portfolio-wide analysis
- Historical data retrieval: <1s for 5-year performance history

**Scalability Requirements:**
- Support 10,000+ users with real-time portfolio tracking
- Handle 1,000,000+ portfolio position updates per day
- Process performance analytics for 100+ portfolio snapshots simultaneously
- Maintain accuracy for portfolios with 1,000+ positions

### File Locations
**Project Structure:** Spring Boot microservices architecture:
- `src/main/java/com/trademaster/portfolio/` - Portfolio service classes
- `src/main/java/com/trademaster/portfolio/service/` - Portfolio business logic
- `src/main/java/com/trademaster/portfolio/analytics/` - Performance and risk analytics
- `src/main/java/com/trademaster/portfolio/model/` - Portfolio and performance models
- `src/main/java/com/trademaster/portfolio/tax/` - Tax calculation components
- `src/main/java/com/trademaster/portfolio/controller/` - Portfolio API controllers
- `src/main/java/com/trademaster/portfolio/websocket/` - Real-time portfolio updates
- `src/main/resources/application.yml` - Portfolio service configuration

### Technical Constraints
**Source: [docs/architecture/core-services-architecture.md#3-trading-api-service]**

**Technology Requirements:**
- Java 21 with Spring Boot 3.x for reactive portfolio processing
- PostgreSQL for transactional portfolio data with proper indexing
- InfluxDB integration for time-series performance data
- Redis caching for frequently accessed portfolio summaries (30s TTL)
- WebSocket for real-time portfolio value broadcasts

**Integration Requirements:**
- Real-time market data integration from Story 2.1 for portfolio valuation
- Trading data integration from Story 2.2 for position updates
- User authentication from Epic 1 for secure portfolio access
- Subscription tier controls for premium analytics features

### Benchmarking & Market Data
**Indian Market Benchmarks:**
- Nifty 50 (broad market large-cap)
- Sensex (BSE benchmark)
- Nifty 500 (broad market)
- Sector-specific indices (Banking, IT, Pharma, etc.)
- Small-cap and mid-cap indices for style analysis

**Benchmark Integration:**
```java
@Service
public class BenchmarkService {
    
    public BenchmarkComparison compareToIndex(Portfolio portfolio, String benchmarkIndex) {
        // Calculate portfolio beta relative to benchmark
        // Compute alpha generation over benchmark
        // Analyze tracking error and information ratio
        // Generate performance attribution analysis
        return benchmarkComparison;
    }
}
```

## Testing

### Testing Standards
**Testing Requirements:** The Developer should implement comprehensive testing following these guidelines:

**Test File Locations:**
- Unit tests: `src/test/java/com/trademaster/portfolio/`
- Integration tests: `src/test/java/com/trademaster/integration/portfolio/`
- Performance tests: `src/test/java/com/trademaster/performance/portfolio/`

**Testing Frameworks and Patterns:**
- JUnit 5 for unit testing framework
- Mockito for mocking market data and external services
- Spring Boot Test for integration testing
- TestContainers for PostgreSQL and InfluxDB integration testing
- WebTestClient for REST API and WebSocket testing
- AssertJ for fluent assertion testing of financial calculations

**Specific Testing Requirements for This Story:**
- Test P&L calculation accuracy with various trade scenarios and corporate actions
- Verify performance metric calculations against known financial benchmarks
- Test risk analytics calculations for mathematical accuracy and edge cases
- Validate tax calculation compliance with Indian capital gains regulations
- Test portfolio rebalancing optimization algorithms with different risk profiles
- Verify real-time portfolio updates propagate correctly to all subscribed clients
- Test performance under high-frequency portfolio update scenarios
- Validate historical performance data accuracy and benchmark comparisons
- Test portfolio alert triggering and notification delivery
- Load testing for portfolio analytics with large position datasets (1000+ positions)

**Financial Calculation Test Requirements:**
- Test time-weighted return calculations with cash flows at different intervals
- Verify Sharpe ratio calculations with different risk-free rates
- Test maximum drawdown calculations with various portfolio scenarios
- Validate beta calculations against multiple benchmark indices
- Test portfolio correlation matrix calculations for accuracy
- Verify Indian tax calculations for different holding periods and transaction types

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References  
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story implementation review*