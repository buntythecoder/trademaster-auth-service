# Story 3.3: Institutional Activity Detection & Smart Money Insights

## Status
Draft

## Story
**As a** TradeMaster retail trader,
**I want** real-time detection and visualization of institutional trading activity with smart money movement insights,
**so that** I can benefit from institutional intelligence, time my trades better, and align my strategies with smart money flow.

## Acceptance Criteria

1. System detects unusual volume patterns indicating institutional activity
2. Statistical analysis identifies block trades and coordinated institutional moves
3. Heat map visualization shows institutional activity intensity across stocks
4. Real-time alerts notify users of detected institutional accumulation/distribution
5. Historical institutional activity patterns are tracked and analyzed
6. Cross-asset correlation analysis detects institutional rotation strategies
7. Institutional activity strength scoring helps users gauge signal quality
8. Smart money movement visualization provides retail traders with institutional insights
9. Activity detection algorithms achieve <5% false positive rate
10. System processes institutional detection for 1000+ stocks simultaneously

## Tasks / Subtasks

- [ ] **Task 1: Volume Analysis & Anomaly Detection** (AC: 1, 9, 10)
  - [ ] Implement statistical volume anomaly detection algorithms
  - [ ] Create baseline volume calculation using historical trading patterns
  - [ ] Set up real-time volume monitoring with configurable thresholds
  - [ ] Build block trade identification using volume and price impact analysis
  - [ ] Implement time-based volume clustering for institutional session detection
  - [ ] Create volume anomaly scoring with confidence intervals
  - [ ] Add machine learning models for volume pattern classification

- [ ] **Task 2: Block Trade & Order Flow Analysis** (AC: 2, 7)
  - [ ] Implement block trade detection using size and frequency analysis
  - [ ] Create order flow analysis for institutional trading pattern recognition
  - [ ] Build coordinated trading detection across multiple stocks
  - [ ] Set up institutional signature recognition (dark pool indicators)
  - [ ] Implement order book impact analysis for large trades
  - [ ] Create institutional activity strength scoring algorithm
  - [ ] Add trade timing analysis for institutional session identification

- [ ] **Task 3: Cross-Asset Correlation & Rotation Analysis** (AC: 6)
  - [ ] Implement cross-asset correlation analysis for sector rotation detection
  - [ ] Create institutional money flow tracking across asset classes
  - [ ] Build sector rotation pattern recognition and alerting
  - [ ] Set up correlation-based institutional strategy identification
  - [ ] Implement asset allocation shift detection for large funds
  - [ ] Create institutional theme identification (growth to value, etc.)
  - [ ] Add institutional portfolio rebalancing pattern detection

- [ ] **Task 4: Real-time Processing & Alert System** (AC: 4, 10)
  - [ ] Set up real-time market data processing pipeline for institutional detection
  - [ ] Implement streaming analytics for immediate institutional activity identification
  - [ ] Create institutional alert generation and notification system
  - [ ] Build alert prioritization based on activity strength and user preferences
  - [ ] Set up scalable processing architecture for 1000+ stocks simultaneously
  - [ ] Implement alert deduplication and intelligent grouping
  - [ ] Add user-specific alert customization and filtering

- [ ] **Task 5: Visualization & Heat Map Components** (AC: 3, 8)
  - [ ] Create institutional activity heat map visualization
  - [ ] Implement real-time heat map updates with smooth animations
  - [ ] Build smart money flow visualization with directional indicators
  - [ ] Create institutional activity intensity color coding and legends
  - [ ] Implement interactive heat map with drill-down capabilities
  - [ ] Add institutional activity historical playback functionality
  - [ ] Create sector-wise institutional activity aggregation views

- [ ] **Task 6: Historical Analysis & Pattern Storage** (AC: 5)
  - [ ] Implement historical institutional activity data storage in InfluxDB
  - [ ] Create institutional pattern historical analysis and trending
  - [ ] Build institutional activity pattern library and classification
  - [ ] Set up historical pattern matching for predictive insights
  - [ ] Implement institutional activity backtesting capabilities
  - [ ] Create institutional signal effectiveness analysis
  - [ ] Add historical institutional rotation pattern analysis

- [ ] **Task 7: API Endpoints & Data Services** (AC: 3, 4, 5, 8)
  - [ ] Create REST API endpoints for institutional activity data retrieval
  - [ ] Implement real-time institutional activity streaming via WebSocket
  - [ ] Add institutional heat map data aggregation endpoints
  - [ ] Create historical institutional pattern query APIs
  - [ ] Implement institutional alert subscription and management APIs
  - [ ] Set up institutional activity analytics and insights endpoints
  - [ ] Add institutional activity export capabilities for analysis

- [ ] **Task 8: Unit and Integration Testing** (AC: All)
  - [ ] Write unit tests for volume anomaly detection algorithms
  - [ ] Create integration tests for real-time institutional activity processing
  - [ ] Test block trade identification accuracy with historical data
  - [ ] Verify cross-asset correlation analysis mathematical correctness
  - [ ] Test institutional alert system under high-volume scenarios
  - [ ] Create load testing for 1000+ simultaneous stock processing
  - [ ] Test heat map visualization performance and accuracy
  - [ ] Validate false positive rate testing with labeled datasets

## Dev Notes

### Previous Story Insights
**From Story 3.1:** Behavioral AI service provides pattern recognition techniques applicable to institutional behavior detection.
**From Epic 2:** Market data service provides real-time price and volume data needed for institutional activity analysis.

### Institutional Detection Algorithms
**Source: [docs/architecture/aiml-services-architecture.md#2-institutional-detection-service]**

**Technology Stack:**
- Python 3.11, Pandas, NumPy, Apache Spark
- Stream processing with batch ML model updates

**Detection Algorithms:**
- **Volume Anomaly Detection:** Statistical analysis of unusual trading volumes
- **Order Flow Analysis:** Pattern recognition in large block trades  
- **Time-based Clustering:** Identifying institutional trading windows
- **Cross-asset Correlation:** Detecting coordinated institutional activity

**Real-time Processing Implementation:**
```python
class InstitutionalDetector:
    def __init__(self):
        self.volume_analyzer = VolumeAnomalyDetector()
        self.flow_analyzer = OrderFlowAnalyzer()
        self.correlation_engine = CrossAssetCorrelator()
    
    async def detect_activity(self, market_stream):
        # Process real-time market data
        # Apply ML models for pattern detection
        # Generate alerts for retail traders
        return institutional_insights
```

### Volume Anomaly Detection
**Statistical Analysis Framework:**
```python
import numpy as np
from scipy import stats
from sklearn.preprocessing import StandardScaler

class VolumeAnomalyDetector:
    def __init__(self, window_size=20, threshold=2.5):
        self.window_size = window_size
        self.threshold = threshold
        self.scaler = StandardScaler()
    
    def detect_volume_anomaly(self, volume_data, price_data):
        # Calculate rolling volume statistics
        rolling_mean = volume_data.rolling(self.window_size).mean()
        rolling_std = volume_data.rolling(self.window_size).std()
        
        # Z-score based anomaly detection
        z_scores = (volume_data - rolling_mean) / rolling_std
        
        # Consider price impact for confirmation
        price_impact = self.calculate_price_impact(price_data, volume_data)
        
        # Combine volume and price signals
        anomaly_score = self.combine_signals(z_scores, price_impact)
        
        return anomaly_score > self.threshold
    
    def calculate_price_impact(self, prices, volumes):
        # Calculate volume-weighted price impact
        # Consider bid-ask spread changes
        # Factor in market microstructure effects
        return price_impact_score
```

### Block Trade Identification
**Block Trade Detection Logic:**
```python
class BlockTradeDetector:
    def __init__(self):
        self.min_block_size = 10000  # Minimum shares for block trade
        self.min_value_threshold = 1000000  # Minimum trade value in INR
    
    def identify_block_trades(self, trades_data):
        block_trades = []
        
        for trade in trades_data:
            # Size-based filtering
            if trade.quantity >= self.min_block_size:
                # Value threshold check
                trade_value = trade.quantity * trade.price
                if trade_value >= self.min_value_threshold:
                    # Time clustering analysis
                    if self.is_institutional_timing(trade.timestamp):
                        # Dark pool indicator analysis
                        if self.analyze_dark_pool_signals(trade):
                            block_trades.append(trade)
        
        return self.rank_by_institutional_probability(block_trades)
    
    def analyze_dark_pool_signals(self, trade):
        # Analyze volume distribution patterns
        # Check for minimal market impact despite large size
        # Look for crossing network indicators
        return dark_pool_probability
```

### Cross-Asset Correlation Analysis
**Institutional Rotation Detection:**
```python
import pandas as pd
from scipy.stats import pearsonr

class InstitutionalRotationDetector:
    def __init__(self):
        self.correlation_threshold = 0.7
        self.rotation_window = 5  # days
    
    def detect_sector_rotation(self, sector_data, timeframe):
        correlations = {}
        
        # Calculate cross-sector correlations
        for sector1 in sector_data:
            for sector2 in sector_data:
                if sector1 != sector2:
                    corr, p_value = pearsonr(
                        sector_data[sector1].volume,
                        sector_data[sector2].volume
                    )
                    
                    # Negative correlation indicates rotation
                    if corr < -self.correlation_threshold and p_value < 0.05:
                        correlations[f"{sector1}_to_{sector2}"] = abs(corr)
        
        # Identify strongest rotation patterns
        return self.rank_rotation_strength(correlations)
    
    def detect_style_rotation(self, growth_stocks, value_stocks):
        # Analyze growth vs value institutional flows
        # Detect style rotation patterns
        # Calculate rotation strength and timing
        return style_rotation_analysis
```

### Data Models
**InfluxDB Institutional Activity Schema:**
```sql
-- Institutional activity measurement
institutional,symbol=TCS,activity_type=accumulation strength=8.5,volume_ratio=3.2 1609459200000000000

-- Block trade measurement
block_trade,symbol=RELIANCE,trade_type=institutional size=50000,impact_score=7.8 1609459200000000000

-- Sector rotation measurement
rotation,from_sector=IT,to_sector=BANKING strength=6.5,confidence=0.89 1609459200000000000
```

**PostgreSQL Institutional Tables (to be created):**
```sql
CREATE TABLE institutional_activities (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    activity_type VARCHAR(50) NOT NULL, -- accumulation, distribution, rotation
    detection_timestamp TIMESTAMP NOT NULL,
    strength_score DECIMAL(3,2) NOT NULL,
    confidence_score DECIMAL(3,2) NOT NULL,
    volume_anomaly_score DECIMAL(5,2),
    price_impact_score DECIMAL(5,2),
    block_trades_count INTEGER DEFAULT 0,
    total_value DECIMAL(15,2),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE block_trades (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    trade_timestamp TIMESTAMP NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    trade_value DECIMAL(15,2) NOT NULL,
    institutional_probability DECIMAL(3,2) NOT NULL,
    dark_pool_indicator BOOLEAN DEFAULT false,
    market_impact_score DECIMAL(3,2),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE institutional_alerts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    symbol VARCHAR(20) NOT NULL,
    alert_type VARCHAR(50) NOT NULL,
    activity_strength DECIMAL(3,2) NOT NULL,
    message TEXT NOT NULL,
    delivered_at TIMESTAMP NOT NULL,
    acknowledged_at TIMESTAMP,
    user_action VARCHAR(50), -- viewed, traded, ignored
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Heat Map Visualization
**Heat Map Component Architecture:**
```typescript
interface InstitutionalHeatMapData {
  symbol: string;
  activityType: 'accumulation' | 'distribution' | 'rotation';
  strengthScore: number; // 0-10
  confidenceScore: number; // 0-1
  volumeAnomaly: number;
  priceImpact: number;
  timestamp: Date;
}

class InstitutionalHeatMap {
  renderHeatMap(data: InstitutionalHeatMapData[]) {
    // Create color-coded heat map based on activity strength
    // Implement smooth real-time updates with animations
    // Add interactive tooltips with detailed information
    // Support zoom and filter capabilities
    // Show historical playback functionality
  }
  
  calculateHeatMapColors(strengthScore: number): string {
    // Green for accumulation (institutions buying)
    // Red for distribution (institutions selling)
    // Blue for rotation (institutional flow changes)
    // Intensity based on strength score
    return colorCode;
  }
}
```

### Real-time Alert System
**Alert Generation Engine:**
```python
class InstitutionalAlertEngine:
    def __init__(self):
        self.alert_thresholds = self.load_user_preferences()
        self.alert_history = {}
    
    async def generate_institutional_alert(self, activity_data):
        # Check if activity meets user-defined thresholds
        if activity_data.strength_score >= self.get_user_threshold(activity_data.user_id):
            
            # Avoid duplicate alerts for same pattern
            if not self.is_duplicate_alert(activity_data):
                
                # Generate personalized alert message
                alert_message = self.create_alert_message(activity_data)
                
                # Deliver via preferred channels
                await self.deliver_alert(activity_data.user_id, alert_message)
                
                # Track alert for effectiveness measurement
                self.track_alert_delivery(activity_data, alert_message)
    
    def create_alert_message(self, activity_data):
        templates = {
            'accumulation': f"ðŸŸ¢ Strong institutional accumulation detected in {activity_data.symbol}. Strength: {activity_data.strength_score}/10",
            'distribution': f"ðŸ”´ Institutional distribution pattern in {activity_data.symbol}. Consider caution. Strength: {activity_data.strength_score}/10", 
            'rotation': f"ðŸ”„ Institutional rotation detected: Funds moving from {activity_data.from_sector} to {activity_data.to_sector}"
        }
        return templates.get(activity_data.activity_type, "Institutional activity detected")
```

### Performance Requirements
**Institutional Detection Performance Targets:**
- Real-time detection latency: <1 second from market data to alert
- Processing capacity: 1000+ stocks simultaneously
- Volume anomaly detection: <100ms per stock per data point
- Heat map update frequency: Real-time with <500ms refresh
- False positive rate: <5% for high-confidence signals

### API Specifications
**Institutional Activity API Endpoints (to be implemented):**
- `GET /api/v1/institutional/activity/{symbol}` - Get institutional activity for specific stock
- `GET /api/v1/institutional/heatmap` - Get current institutional activity heat map data
- `GET /api/v1/institutional/alerts` - Get user's institutional alerts
- `POST /api/v1/institutional/alerts/subscribe` - Subscribe to institutional alerts
- `GET /api/v1/institutional/historical/{symbol}` - Get historical institutional patterns
- `GET /api/v1/institutional/rotation` - Get current sector rotation analysis
- `WebSocket /ws/institutional` - Real-time institutional activity stream
- `GET /api/v1/institutional/analytics` - Get institutional activity analytics

### File Locations
**Project Structure:** Python analytics service:
- `src/institutional_detection/` - Main institutional detection service
- `src/institutional_detection/analyzers/` - Volume and block trade analyzers
- `src/institutional_detection/correlation/` - Cross-asset correlation analysis
- `src/institutional_detection/alerts/` - Alert generation and delivery
- `src/institutional_detection/visualization/` - Heat map data preparation
- `src/institutional_detection/models/` - Data models and database schemas
- `src/institutional_detection/api/` - REST API and WebSocket endpoints
- `tests/` - Unit and integration tests
- `configs/` - Detection algorithm configuration

### Integration Requirements
**Service Integration:**
- Epic 2 Market Data Service: Real-time price and volume data for analysis
- Story 3.1 Behavioral AI: Pattern recognition techniques for institutional behavior
- Epic 1 Authentication: User-specific alert preferences and subscription tiers
- Notification service: Multi-channel alert delivery (push, email, SMS)
- InfluxDB: Time-series storage for institutional activity patterns

## Testing

### Testing Standards
**Testing Requirements:** The Developer should implement comprehensive testing following these guidelines:

**Test File Locations:**
- Unit tests: `tests/unit/institutional_detection/`
- Integration tests: `tests/integration/institutional_detection/`
- Performance tests: `tests/performance/institutional_detection/`
- Algorithm tests: `tests/algorithms/institutional_detection/`

**Testing Frameworks and Patterns:**
- pytest for Python unit testing
- pandas testing utilities for data analysis validation
- Statistical testing libraries for algorithm validation
- Apache Spark testing for large-scale data processing
- WebSocket testing utilities for real-time data streaming

**Specific Testing Requirements for This Story:**
- Test volume anomaly detection accuracy with labeled institutional trading data
- Verify block trade identification precision and recall metrics
- Test cross-asset correlation analysis mathematical correctness
- Validate institutional alert generation and delivery systems
- Test heat map data accuracy and real-time update performance
- Load testing for 1000+ simultaneous stock processing
- Test false positive rate with comprehensive backtesting
- Verify API integration with market data and authentication services
- Test institutional pattern historical analysis and storage
- Validate alert customization and user preference handling

**Statistical Validation Requirements:**
- Backtest detection algorithms against known institutional activity periods
- Validate statistical significance of correlation analysis
- Test algorithm performance across different market conditions
- Verify detection accuracy for different types of institutional strategies

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References  
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story implementation review*