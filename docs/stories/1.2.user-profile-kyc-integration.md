# Story 1.2: User Profile Management & KYC Integration

## Status
Draft

## Story
**As a** TradeMaster user with authenticated account,
**I want** to create and manage my trading profile with KYC verification and subscription tier management,
**so that** I can comply with SEBI regulations, access appropriate trading features, and customize my trading experience based on my risk tolerance and preferences.

## Acceptance Criteria

1. Users can create and update their trading profiles with personal information
2. System integrates with KYC verification service for regulatory compliance
3. User subscription tiers (free, smart trader, professional, institutional) are managed
4. Profile data is encrypted and stored securely in PostgreSQL
5. Users can set trading preferences and risk tolerance levels
6. System tracks KYC status and enforces trading limits based on verification level
7. Profile changes are logged for audit and compliance purposes

## Tasks / Subtasks

- [ ] **Task 1: User Profile Data Model & Service** (AC: 1, 4, 7)
  - [ ] Extend user_profiles table schema with comprehensive trading profile fields
  - [ ] Implement UserProfileService with CRUD operations for profile management
  - [ ] Add data validation for required fields and format constraints
  - [ ] Implement field-level encryption for sensitive personal information
  - [ ] Create profile change tracking and audit logging functionality
  - [ ] Add profile completeness scoring and validation
  - [ ] Implement profile data export capabilities for user data portability

- [ ] **Task 2: KYC Integration Service** (AC: 2, 6)
  - [ ] Research and integrate with Indian KYC verification providers (DigiLocker, Aadhaar eSign)
  - [ ] Implement KYC document upload and verification workflow
  - [ ] Create KYC status tracking (pending, in_progress, verified, rejected)
  - [ ] Add automatic trading limit enforcement based on KYC verification level
  - [ ] Implement KYC document storage with encryption and access controls
  - [ ] Create KYC renewal and re-verification processes
  - [ ] Add SEBI compliance reporting for KYC verification status

- [ ] **Task 3: Subscription Tier Management** (AC: 3)
  - [ ] Implement subscription tier enum and validation (free, smart_trader, professional, institutional)
  - [ ] Create subscription tier upgrade/downgrade workflow
  - [ ] Add feature access control based on subscription tier
  - [ ] Implement tier-specific trading limits and API rate limits
  - [ ] Create subscription tier analytics and usage tracking
  - [ ] Add subscription tier change notifications and confirmations
  - [ ] Implement promotional tier upgrades and trial periods

- [ ] **Task 4: Trading Preferences & Risk Management** (AC: 5)
  - [ ] Create trading preferences data model (risk tolerance, trading style, notification preferences)
  - [ ] Implement risk tolerance questionnaire and scoring system
  - [ ] Add trading experience level tracking and validation
  - [ ] Create personalized trading limits based on risk profile
  - [ ] Implement notification preferences for alerts and updates
  - [ ] Add trading goal setting and progress tracking
  - [ ] Create preference-based feature customization

- [ ] **Task 5: Profile API Endpoints** (AC: 1, 3, 5)
  - [ ] Create REST endpoints for profile CRUD operations
  - [ ] Implement profile validation and error handling
  - [ ] Add subscription tier management endpoints
  - [ ] Create KYC status and document management endpoints
  - [ ] Implement trading preferences configuration endpoints
  - [ ] Add profile analytics and insights endpoints
  - [ ] Create bulk profile operations for administrative use

- [ ] **Task 6: Compliance & Regulatory Integration** (AC: 2, 6, 7)
  - [ ] Implement SEBI compliance checks for trading eligibility
  - [ ] Create regulatory reporting for user verification status
  - [ ] Add automated compliance monitoring and alerting
  - [ ] Implement data retention policies for regulatory requirements
  - [ ] Create audit trail for all profile and KYC changes
  - [ ] Add regulatory document generation and storage
  - [ ] Implement compliance dashboard for administrative oversight

- [ ] **Task 7: Security & Data Protection** (AC: 4, 7)
  - [ ] Implement AES-256 encryption for sensitive profile data
  - [ ] Add access logging for all profile data operations
  - [ ] Create data anonymization for analytics and reporting
  - [ ] Implement data backup and recovery procedures
  - [ ] Add GDPR-style data deletion capabilities
  - [ ] Create security monitoring for profile data access
  - [ ] Implement data integrity validation and checksums

- [ ] **Task 8: Unit and Integration Testing** (AC: All)
  - [ ] Write unit tests for profile service operations and validation
  - [ ] Create integration tests for KYC service integration
  - [ ] Test subscription tier enforcement and feature access controls
  - [ ] Test encryption/decryption of sensitive profile data
  - [ ] Test compliance workflows and regulatory reporting
  - [ ] Test profile change audit logging and tracking
  - [ ] Create load testing for profile operations under high concurrency
  - [ ] Test data migration and backup/recovery procedures

## Dev Notes

### Previous Story Insights
**From Story 1.1:** Authentication system provides secure user sessions, JWT tokens, and basic user management that will be extended with detailed profile information.

### Data Models
**Source: [docs/architecture/data-architecture.md#postgresql-primary-transactional-database]**

**Existing User Profiles Schema:**
```sql
CREATE TABLE user_profiles (
    user_id INTEGER REFERENCES users(id),
    risk_tolerance VARCHAR(20),
    trading_experience VARCHAR(20),
    behavioral_settings JSONB,
    preferences JSONB
);
```

**Extended User Profiles Schema (to be implemented):**
```sql
-- Enhanced user_profiles table
ALTER TABLE user_profiles ADD COLUMN IF NOT EXISTS 
    full_name VARCHAR(255) ENCRYPTED,
    date_of_birth DATE ENCRYPTED,
    phone_number VARCHAR(20) ENCRYPTED,
    address TEXT ENCRYPTED,
    pan_number VARCHAR(10) ENCRYPTED,
    aadhaar_number VARCHAR(12) ENCRYPTED,
    kyc_status VARCHAR(20) DEFAULT 'pending',
    kyc_verified_at TIMESTAMP,
    kyc_expiry_date DATE,
    income_range VARCHAR(50),
    occupation VARCHAR(100),
    trading_goals TEXT,
    notification_preferences JSONB DEFAULT '{}',
    profile_completeness_score INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW();

-- KYC documents table
CREATE TABLE kyc_documents (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    document_type VARCHAR(50) NOT NULL, -- PAN, AADHAAR, BANK_STATEMENT, etc.
    document_url VARCHAR(500) ENCRYPTED,
    document_hash VARCHAR(64) NOT NULL,
    verification_status VARCHAR(20) DEFAULT 'pending',
    verification_notes TEXT,
    uploaded_at TIMESTAMP DEFAULT NOW(),
    verified_at TIMESTAMP,
    expiry_date DATE
);

-- Subscription tiers tracking
CREATE TABLE user_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    tier VARCHAR(20) NOT NULL DEFAULT 'free',
    effective_date DATE NOT NULL,
    expiry_date DATE,
    payment_status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### KYC Integration Requirements
**Indian KYC Compliance Standards:**
- Aadhaar-based eKYC for digital verification
- PAN card verification for tax compliance
- Bank account verification for fund transfers
- Address verification using utility bills or bank statements
- Income verification for trading limit determination

**KYC Integration Architecture:**
```java
@Service
public class KYCService {
    
    public KYCResult initiateKYCVerification(User user, KYCDocuments documents) {
        // Validate document formats and completeness
        // Submit to external KYC verification service
        // Store encrypted documents with secure access
        // Update KYC status and tracking
        return kycResult;
    }
    
    public boolean isKYCCompliantForTrading(User user, TradeAmount amount) {
        // Check KYC verification status and level
        // Validate trading limits based on KYC level
        // Ensure compliance with SEBI regulations
        return isCompliant;
    }
}
```

### Subscription Tier Management
**Source: [docs/prd/epic-5-gamification-subscriptions.md]**

**Subscription Tier Structure:**
- **Free Tier (₹0/month):** Basic features, delayed data, limited trading
- **Smart Trader (₹399/month):** Real-time data, basic AI features
- **Professional (₹1,199/month):** Advanced analytics, institutional detection
- **Institutional (₹3,999/month):** Full feature access, dedicated support

**Tier Management Implementation:**
```java
@Service
public class SubscriptionService {
    
    public void upgradeSubscription(User user, SubscriptionTier newTier) {
        // Validate upgrade eligibility and payment
        // Update user tier and effective dates
        // Enable/disable features based on new tier
        // Log subscription change for billing
    }
    
    public boolean hasFeatureAccess(User user, String featureName) {
        // Check current subscription tier
        // Validate feature availability for tier
        // Consider trial periods and promotions
        return hasAccess;
    }
}
```

### API Specifications
**Profile Management API Endpoints (to be implemented):**
- `GET /api/v1/profile` - Get user profile information
- `PUT /api/v1/profile` - Update user profile
- `POST /api/v1/profile/kyc/upload` - Upload KYC documents
- `GET /api/v1/profile/kyc/status` - Get KYC verification status
- `PUT /api/v1/profile/preferences` - Update trading preferences
- `GET /api/v1/profile/subscription` - Get subscription tier information
- `POST /api/v1/profile/subscription/upgrade` - Upgrade subscription tier
- `GET /api/v1/profile/compliance` - Get compliance status and requirements

### Trading Preferences Model
**Risk Tolerance Levels:**
- Conservative: Low-risk investments, capital preservation focus
- Moderate: Balanced risk/return profile, diversified portfolio
- Aggressive: High-risk/high-return tolerance, growth focus
- Very Aggressive: Maximum risk tolerance, speculative trading

**Trading Preferences Schema:**
```json
{
  "riskTolerance": "moderate",
  "tradingExperience": "intermediate",
  "investmentHorizon": "long_term",
  "tradingStyle": "swing_trading",
  "notificationPreferences": {
    "priceAlerts": true,
    "behavioralCoaching": true,
    "marketNews": false,
    "promotionalOffers": true
  },
  "tradingLimits": {
    "maxDailyLoss": 10000,
    "maxPositionSize": 50000,
    "maxLeverage": 2.0
  }
}
```

### File Locations
**Project Structure:** Spring Boot microservices architecture:
- `src/main/java/com/trademaster/profile/` - Profile service classes
- `src/main/java/com/trademaster/profile/service/` - Profile business logic
- `src/main/java/com/trademaster/profile/kyc/` - KYC integration components
- `src/main/java/com/trademaster/profile/subscription/` - Subscription management
- `src/main/java/com/trademaster/profile/model/` - Profile and KYC data models
- `src/main/java/com/trademaster/profile/controller/` - Profile API controllers
- `src/main/java/com/trademaster/profile/compliance/` - Regulatory compliance
- `src/main/resources/application.yml` - Profile service configuration

### Security & Encryption Requirements
**Source: [docs/architecture/security-architecture.md#data-protection]**

**Encryption Strategy:**
- Data at Rest: AES-256 encryption for sensitive profile data
- Key Management: AWS KMS for encryption key lifecycle
- Field-level encryption for PII (name, address, PAN, Aadhaar)
- Secure document storage with access controls

**Privacy Implementation:**
```java
@Entity
@Table(name = "user_profiles")
public class UserProfile {
    
    @Encrypted
    @Column(name = "full_name")
    private String fullName;
    
    @Encrypted 
    @Column(name = "pan_number")
    private String panNumber;
    
    @Anonymized
    @Column(name = "trading_patterns")
    private String tradingPatterns;
}
```

### SEBI Compliance Requirements
**KYC Compliance Levels:**
- **Simplified KYC:** For accounts with limited trading (₹50,000 annual limit)
- **Full KYC:** Complete verification for unlimited trading
- **Enhanced KYC:** For high-value clients and institutional accounts

**Trading Limits by KYC Status:**
- **Pending KYC:** No trading allowed, profile creation only
- **Simplified KYC:** ₹50,000 annual trading limit
- **Full KYC:** Normal trading limits based on risk profile
- **Enhanced KYC:** Institutional-level trading access

### Performance Requirements
**Source: [docs/architecture/performance-scalability.md#performance-targets]**

**Profile Performance Targets:**
- Profile API response time: <200ms for profile operations
- KYC document upload: <5s for documents up to 10MB
- Subscription tier updates: <100ms for real-time feature enablement
- Profile data encryption/decryption: <50ms overhead

**Scalability Requirements:**
- Support 10,000+ user profiles with efficient querying
- Handle 1,000+ concurrent profile updates
- Process 100+ KYC verifications simultaneously
- Maintain data consistency across subscription changes

### Technical Constraints
**Source: [docs/architecture/core-services-architecture.md#2-authentication-authorization-service]**

**Integration Requirements:**
- Must extend Epic 1 authentication without breaking existing functionality
- Integrate with user session management from Story 1.1
- Support JWT token claims for subscription tier and KYC status
- Maintain backward compatibility for existing authenticated users

## Testing

### Testing Standards
**Testing Requirements:** The Developer should implement comprehensive testing following these guidelines:

**Test File Locations:**
- Unit tests: `src/test/java/com/trademaster/profile/`
- Integration tests: `src/test/java/com/trademaster/integration/profile/`
- Security tests: `src/test/java/com/trademaster/security/profile/`

**Testing Frameworks and Patterns:**
- JUnit 5 for unit testing framework
- Mockito for mocking KYC services and external integrations
- Spring Boot Test for integration testing
- TestContainers for PostgreSQL integration testing
- Spring Security Test for authentication and authorization testing
- WireMock for KYC service API simulation

**Specific Testing Requirements for This Story:**
- Test profile CRUD operations with field validation and encryption
- Verify KYC document upload, storage, and verification workflows
- Test subscription tier enforcement for feature access controls
- Validate trading limit enforcement based on KYC verification level
- Test profile change audit logging and compliance reporting
- Verify encryption/decryption of sensitive profile data
- Test profile data export and deletion for regulatory compliance
- Load testing for concurrent profile operations and KYC processing
- Test integration with authentication service from Story 1.1
- Validate SEBI compliance workflows and regulatory reporting

**KYC-Specific Test Scenarios:**
- Test document format validation and security scanning
- Verify KYC status transitions and limit enforcement
- Test KYC renewal and re-verification processes
- Validate compliance reporting and audit trail generation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References  
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story implementation review*