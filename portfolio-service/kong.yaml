# Kong Gateway Configuration for TradeMaster Portfolio Service
# Compatible with Kong Gateway 3.x and Kong Ingress Controller

_format_version: "3.0"

# ==================== SERVICES ====================
services:
  - name: trademaster-portfolio-service
    protocol: http
    host: portfolio-service
    port: 8083
    retries: 3
    connect_timeout: 10000
    write_timeout: 30000
    read_timeout: 30000
    tags:
      - trademaster
      - portfolio
      - production

# ==================== UPSTREAMS ====================
upstreams:
  - name: portfolio-service-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_cookie_path: /
    slots: 10000
    healthchecks:
      active:
        type: http
        timeout: 5
        concurrency: 5
        http_path: /actuator/health
        https_verify_certificate: false
        healthy:
          interval: 5
          http_statuses: [200, 201, 202, 204]
          successes: 3
        unhealthy:
          interval: 5
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 3
          http_failures: 3
          timeouts: 3
      passive:
        type: http
        healthy:
          http_statuses: [200, 201, 202, 204, 301, 302, 401, 403, 404]
          successes: 3
        unhealthy:
          http_statuses: [429, 500, 502, 503, 504]
          tcp_failures: 3
          http_failures: 3
          timeouts: 3
      threshold: 0
    tags:
      - trademaster
      - portfolio
    targets:
      - target: portfolio-service:8083
        weight: 100
        tags:
          - primary

# ==================== ROUTES ====================
routes:
  # Portfolio Management API Routes (External - JWT Protected)
  - name: portfolio-api-portfolios
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    paths: ["/api/v1/portfolios", "/api/v1/portfolios/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - portfolio
      - management
      - external

  # Position Tracking API Routes (External - JWT Protected)
  - name: portfolio-api-positions
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    paths: ["/api/v1/portfolios/.*/positions", "/api/v1/portfolios/.*/positions/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - portfolio
      - positions
      - external

  # P&L Calculation API Routes (External - JWT Protected)
  - name: portfolio-api-pnl
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, POST, OPTIONS]
    paths: ["/api/v1/portfolios/.*/pnl", "/api/v1/portfolios/.*/pnl/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - portfolio
      - pnl
      - external

  # Risk Analytics API Routes (External - JWT Protected)
  - name: portfolio-api-risk
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, POST, OPTIONS]
    paths: ["/api/v1/portfolios/.*/risk", "/api/v1/portfolios/.*/risk/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - portfolio
      - risk
      - external

  # Performance Analytics API Routes (External - JWT Protected)
  - name: portfolio-api-analytics
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/api/v1/portfolios/.*/analytics", "/api/v1/portfolios/.*/analytics/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - portfolio
      - analytics
      - external

  # Health Check Routes (Public)
  - name: portfolio-health-check
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/actuator/health", "/api/v2/health"]
    preserve_host: false
    strip_path: false
    tags:
      - health
      - monitoring

  # Internal Service Routes (Service-to-Service - API Key Protected)
  - name: portfolio-internal-api
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, POST, PUT, DELETE, OPTIONS]
    paths: ["/api/internal/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - internal
      - service-to-service

  # Greetings Service Discovery Routes (Internal - API Key Protected)
  - name: portfolio-greetings
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/api/internal/greetings"]
    preserve_host: false
    strip_path: false
    tags:
      - greetings
      - discovery
      - internal

  # OpenAPI Documentation Routes (Public)
  - name: portfolio-openapi-docs
    service: trademaster-portfolio-service
    protocols: [http, https]
    methods: [GET, OPTIONS]
    paths: ["/v3/api-docs", "/v3/api-docs/.*", "/swagger-ui.html", "/swagger-ui/.*"]
    preserve_host: false
    strip_path: false
    tags:
      - documentation
      - openapi

# ==================== PLUGINS ====================
plugins:
  # CORS Plugin (Global)
  - name: cors
    config:
      origins:
        - "https://app.trademaster.com"
        - "https://admin.trademaster.com"
        - "http://localhost:3000"  # Development
        - "http://localhost:5173"  # Vite development
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - HEAD
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - X-Correlation-ID
        - X-Service-API-Key
        - X-Service-ID
      exposed_headers:
        - X-Auth-Token
        - X-Correlation-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - cors
      - global

  # Rate Limiting Plugin (Global)
  - name: rate-limiting
    config:
      minute: 1000      # Portfolio operations per minute
      hour: 50000       # Portfolio operations per hour
      day: 1000000      # Daily capacity
      month: 25000000   # Monthly capacity
      year: 300000000   # Yearly capacity
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      header_name: X-RateLimit-Limit
      limit_by: consumer
    tags:
      - rate-limiting
      - global

  # Request ID Plugin
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
    tags:
      - correlation
      - tracing

  # Prometheus Metrics Plugin
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
    tags:
      - metrics
      - monitoring

  # Request Logging Plugin
  - name: http-log
    config:
      http_endpoint: "http://log-aggregator:8080/kong-logs"
      method: POST
      timeout: 1000
      keepalive: 1000
      content_type: application/json
      flush_timeout: 2
      retry_count: 3
      queue_size: 100
    tags:
      - logging
      - audit

  # JWT Authentication Plugin (Applied to external portfolio routes)
  - name: jwt
    route: portfolio-api-portfolios
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  - name: jwt
    route: portfolio-api-positions
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  - name: jwt
    route: portfolio-api-pnl
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  - name: jwt
    route: portfolio-api-risk
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  - name: jwt
    route: portfolio-api-analytics
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      header_names:
        - authorization
      claims_to_verify:
        - exp
        - iat
      key_claim_name: iss
      secret_is_base64: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - jwt

  # Service API Key Authentication for Internal Routes
  - name: key-auth
    route: portfolio-internal-api
    config:
      key_names:
        - X-Service-API-Key
        - api-key
      key_in_header: true
      key_in_query: false
      key_in_body: false
      hide_credentials: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - service-api-key
      - internal

  - name: key-auth
    route: portfolio-greetings
    config:
      key_names:
        - X-Service-API-Key
        - api-key
      key_in_header: true
      key_in_query: false
      key_in_body: false
      hide_credentials: false
      anonymous: false
      run_on_preflight: true
    tags:
      - auth
      - service-api-key
      - greetings

  # Enhanced Rate Limiting for Portfolio Operations
  - name: rate-limiting
    route: portfolio-api-portfolios
    config:
      minute: 100       # 100 portfolio operations per minute per user
      hour: 5000        # 5000 portfolio operations per hour per user
      day: 50000        # 50000 portfolio operations per day per user
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      limit_by: consumer
    tags:
      - rate-limiting
      - portfolio

  - name: rate-limiting
    route: portfolio-api-pnl
    config:
      minute: 200       # 200 P&L calculations per minute per user
      hour: 10000       # 10000 P&L calculations per hour per user
      day: 100000       # 100000 P&L calculations per day per user
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      limit_by: consumer
    tags:
      - rate-limiting
      - pnl

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10240  # 10KB for portfolio payloads
    tags:
      - request-size
      - security

  # Response Caching for Analytics
  - name: proxy-cache
    route: portfolio-api-analytics
    config:
      strategy: memory
      cache_ttl: 300         # 5 minutes cache for analytics
      cache_control: true
      memory:
        dictionary_name: kong_cache
    tags:
      - caching
      - performance

# ==================== CONSUMERS ====================
consumers:
  - username: trademaster-portfolio-app
    custom_id: portfolio-app-001
    tags:
      - application
      - portfolio

  - username: trademaster-admin
    custom_id: admin-001
    tags:
      - admin
      - backend

  - username: trademaster-monitor
    custom_id: monitor-001
    tags:
      - monitoring
      - system

  - username: trading-service
    custom_id: trading-service-001
    tags:
      - service
      - internal

  - username: risk-service
    custom_id: risk-service-001
    tags:
      - service
      - internal

  - username: notification-service
    custom_id: notification-service-001
    tags:
      - service
      - internal

  - username: event-bus-service
    custom_id: event-bus-service-001
    tags:
      - service
      - internal

# ==================== CONSUMER CREDENTIALS ====================
jwt_secrets:
  - consumer: trademaster-portfolio-app
    key: trademaster-portfolio-app-key
    algorithm: HS256
    secret: "${TRADEMASTER_PORTFOLIO_JWT_SECRET}"
    tags:
      - jwt-secret
      - app

  - consumer: trademaster-admin
    key: trademaster-admin-key
    algorithm: HS256
    secret: "${TRADEMASTER_ADMIN_JWT_SECRET}"
    tags:
      - jwt-secret
      - admin

keyauth_credentials:
  - consumer: trademaster-admin
    key: "${TRADEMASTER_ADMIN_API_KEY}"
    tags:
      - api-key
      - admin

  - consumer: trademaster-monitor
    key: "${TRADEMASTER_MONITOR_API_KEY}"
    tags:
      - api-key
      - monitor

  - consumer: trading-service
    key: "${TRADEMASTER_SERVICE_API_KEY}"
    tags:
      - api-key
      - service

  - consumer: risk-service
    key: "${TRADEMASTER_SERVICE_API_KEY}"
    tags:
      - api-key
      - service

  - consumer: notification-service
    key: "${TRADEMASTER_SERVICE_API_KEY}"
    tags:
      - api-key
      - service

  - consumer: event-bus-service
    key: "${TRADEMASTER_SERVICE_API_KEY}"
    tags:
      - api-key
      - service

# ==================== CERTIFICATES (HTTPS) ====================
certificates:
  - cert: |
      -----BEGIN CERTIFICATE-----
      # Your SSL certificate here
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      # Your private key here
      -----END PRIVATE KEY-----
    tags:
      - ssl
      - https

# ==================== SNIs ====================
snis:
  - name: portfolio.trademaster.com
    certificate: certificates[0]
    tags:
      - domain
      - production

  - name: staging-portfolio.trademaster.com
    certificate: certificates[0]
    tags:
      - domain
      - staging
